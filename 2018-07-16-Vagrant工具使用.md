---
title: Vagrantå·¥å…·ä½¿ç”¨
date: 2018-07-16 13:18:31
categories: "è™šæ‹ŸåŒ–"
tags: [vagrant]
---


# Vagrantç®€ä»‹

>Vagrant is an amazing tool for managing virtual machines via a simple to use command line interface. With a simple vagrant up you can be working in a clean environment based on a standard template.

Vagrantæ˜¯æ„å»ºåœ¨è™šæ‹ŸåŒ–æŠ€æœ¯ä¹‹ä¸Šçš„è™šæ‹Ÿæœºè¿è¡Œç¯å¢ƒç®¡ç†å·¥å…·ï¼Œé€šè¿‡Vagrantå¯ä»¥æ–¹ä¾¿å®ç°å¯¹è™šæ‹Ÿæœºçš„ç®¡ç†ï¼ŒåŒ…æ‹¬å»ºç«‹å’Œåˆ é™¤è™šæ‹Ÿæœºã€é…ç½®è™šæ‹Ÿæœºè¿è¡Œå‚æ•°ã€ç®¡ç†è™šæ‹Ÿæœºè¿è¡ŒçŠ¶æ€ï¼Œè‡ªåŠ¨åŒ–é…ç½®å’Œå®‰è£…å¼€å‘æµ‹è¯•ç¯å¢ƒæ‰€å¿…é¡»çš„å„ç±»è½¯ä»¶ã€æ‰“åŒ…å’Œåˆ†å‘è™šæ‹Ÿæœºè¿è¡Œç¯å¢ƒï¼›

# ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å®ƒï¼Ÿ

1. ç»Ÿä¸€ç¯å¢ƒï¼Œé€šè¿‡Vagrantå°è£…ä¸€ä¸ªLinuxå¼€å‘ç¯å¢ƒï¼Œåˆ†å‘ç»™å›¢é˜Ÿæˆå‘˜ä½¿ç”¨ï¼›
2. èŠ‚çœæ—¶é—´ï¼Œç¼©çŸ­åˆ›å»ºå¼€å‘ç¯å¢ƒçš„æ—¶é—´ï¼›
3. åˆ›å»ºç¯å¢ƒå‰¯æœ¬ï¼Œé˜²æ­¢æ“ä½œé€ æˆå¯¹å¼€å‘ç¯å¢ƒçš„æ±¡æŸ“ï¼›

<!-- more -->

# é‡è¦ç»„ä»¶æœ‰å“ªäº›ï¼Ÿ

- providerï¼š
æä¾›å•†ï¼ŒVagrantç”±äºå®ƒæœ¬èº«å¹¶æ²¡æœ‰èƒ½åŠ›åˆ›å»ºè™šæ‹Ÿæœºï¼Œå®ƒæ˜¯æ„å»ºåœ¨è™šæ‹ŸåŒ–æŠ€æœ¯ä¹‹ä¸Šçš„ç®¡ç†å·¥å…·ï¼Œæ‰€ä»¥è¿™é‡Œçš„ProvideræŒ‡çš„æ˜¯å“ªäº›è™šæ‹ŸåŒ–æŠ€æœ¯ä¾›Vagrantæ¥è°ƒç”¨ï¼Œå¦‚VirtualBoxã€VMwareã€Xenã€Dockerï¼Œè¿™äº›è™šæ‹ŸåŒ–å·¥å…·å®‰è£…å¥½å³å¯ï¼Œvagrantä¼šè‡ªåŠ¨å°è£…åœ¨åº•å±‚ï¼Œé€šè¿‡ç»Ÿä¸€çš„å‘½ä»¤æ¥è°ƒç”¨ï¼Œå› æ­¤è¦ä½¿ç”¨Vagrantå°±éœ€è¦ä½ çš„ç”µè„‘ä¸Šé¢å®‰è£…Providerï¼Œé»˜è®¤é€‰æ‹©virtualboxï¼›

- boxï¼šä¾›Vagrantç›´æ¥ä½¿ç”¨çš„è™šæ‹Ÿæœºé•œåƒæ–‡ä»¶ï¼Œ[å®˜æ–¹ä¸‹è½½1](http://www.vagrantbox.es/)ï¼Œä¹Ÿå¯ä»¥ä»[å®˜æ–¹ä¸‹è½½2](https://app.vagrantup.com/boxes/search); 
- Vagrantfileï¼šVagrantæ˜¯æ ¹æ®Vagrantfileä¸­çš„é…ç½®æ¥åˆ›å»ºè™šæ‹Ÿæœºï¼Œé…ç½®æ–‡ä»¶çš„è¯­æ³•æ˜¯Rubyï¼Œé‡Œé¢å¯ä»¥å®šä¹‰box, ç½‘ç»œï¼Œå…±äº«ç›®å½•ï¼Œprovisionè„šæœ¬ç­‰ï¼›
- Provisioningï¼šè™šæ‹Ÿæœºå¯åŠ¨ä½¿ç”¨shellæˆ–è€…puppetã€chefæ¥å®Œæˆä¸€äº›åŸºç¡€é…ç½®å·¥ä½œï¼›
- Pluginï¼šæ”¯æŒadd-onï¼Œå¾ˆå¤šç¬¬ä¸‰æ–¹æ’ä»¶æ”¯æŒï¼›

# å®‰è£… 

1. è™šæ‹ŸåŒ–æŠ€æœ¯æ”¯æ’‘å·¥å…·å®‰è£…
 
 	[virtualboxå®˜æ–¹åœ°å€](https://www.virtualbox.org/)
 	å®‰è£…è¯·å‚ç…§å®˜ç½‘ï¼Œè¿™é‡Œçœç•¥â€¦â€¦

2. å®‰è£…vagrant
	
	[vagrantå®˜æ–¹åœ°å€](https://www.vagrantup.com/)
	å®‰è£…å‚ç…§å®˜ç½‘ç•¥ï¼Œè¿™é‡Œçœç•¥â€¦â€¦
	
# ä½¿ç”¨æ­¥éª¤

## æ·»åŠ Boxé•œåƒ

```shell
vagrant box add {title} {box-url}|æœ¬åœ°Boxæ–‡ä»¶
```
ä½¿ç”¨box-urlçš„æ–¹å¼çš„è¯ï¼Œä¼°è®¡ä¼šæ¯”è¾ƒæ…¢ï¼Œå¤§å®¶éƒ½æ‡‚ğŸ˜€ğŸ¤—ï¼Œå»ºè®®ä¸‹è½½åˆ°æœ¬åœ°åå†ä½¿ç”¨ï¼›

```shell
vagrant box list 
```
æŸ¥çœ‹æœ¬åœ°çš„boxåˆ—è¡¨

```shell
vagrant box remove {title}
```
åˆ é™¤æœ¬åœ°çš„box
	
	
## åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
### å‘½ä»¤è‡ªåŠ¨åˆ›å»ºvagrantfileæ–‡ä»¶

```shell
vagrant init {title}
```

åœ¨ä¸€ä¸ªprojecté¡¹ç›®ä¸‹é¢ï¼ˆé€šä¿—è®²åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢ï¼‰ï¼Œä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªVagrantfileæ–‡ä»¶ï¼Œä½ å¯ä»¥é€šè¿‡ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶æ¥å®ç°ä½ æ‰€è¦çš„è®¾ç½®ï¼›

### é€šè¿‡æ‰‹å†™æˆ–è€…copy vagrantfileæ–‡ä»¶

æŠŠå†™å¥½çš„ã€é€šè¿‡å…¶å®ƒæ–¹å¼copyæˆ–ä¸‹è½½æ¥çš„Vagrantfileæ–‡ä»¶ï¼Œæ”¾åœ¨ä¸€ä¸ªé¡¹ç›®ä¸‹é¢ï¼›

### å¯åŠ¨

```shell
vagrant up [ä¸»æœºå]
```

### è¿æ¥

```shell
vagrant ssh [ä¸»æœºå]
```

ç›´æ¥å°±å¯ä»¥sshè¿›å»ï¼ŒåŸå› æ˜¯vagrantåˆ›å»ºçš„æ—¶å€™ï¼Œå·²ç»å¸®æˆ‘ä»¬å®Œæˆäº†sshä¿¡ä»»ç›¸å…³çš„æ“ä½œï¼Œç»™ç”¨æˆ·æ›´å¥½çš„ä½“éªŒï¼›


# é…ç½®æ–‡ä»¶

- vagranté…ç½®æ–‡ä»¶åç§°ä¸ºVagrantfileï¼›
- vagrantä½¿ç”¨Rubyå¼€å‘çš„ï¼Œæ‰€æœ‰çš„é…ç½®æ–‡ä»¶ä¹Ÿç»§æ‰¿äº†Rubyçš„è¯­æ³•æ ¼å¼ï¼›
- é…ç½®æ–‡ä»¶ä¿®æ”¹è¿‡åï¼Œéœ€è¦vagrant reload 
- é‡å¯VMåï¼Œä¿®æ”¹é…ç½®æ–¹å¯ç”Ÿæ•ˆï¼›

## é…ç½®åŸºæœ¬è¯´æ˜

```ruby
Vagrant.configure(2) do |config|
	# ......
end
```

configure(2)ï¼šä½¿ç”¨Vagrant 2.0.xé…ç½®æ–¹å¼

## boxè®¾ç½®

```ruby
config.vm.box = "centos7"
```

è¿™é‡Œè®¾ç½®ä½¿ç”¨çš„å“ªä¸ªboxä½œä¸ºè™šæ‹Ÿç³»ç»Ÿï¼Œè¿™é‡Œçš„centos7ï¼Œå°±æ˜¯æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„{title}çš„å˜é‡,é»˜è®¤ä¸ºbaseï¼Œä¸è¿‡è¿™ä¸ªå¯ä»¥ä¿®æ”¹ï¼Œéœ€è¦ä½¿ç”¨virtualå·¥å…·VBoxManagerå‘½ä»¤è¡Œå·¥å…·è®¾å®šVMï¼›

## providerè®¾ç½®

``` ruby
config.vm.provider "virtualbox" do |v|
  v.customize ["modifyvm", :id, "--memory", "512"]
  v.customize ["modifyvm", :id, "--cpus", "1"]
end
æˆ–è€…
config.vm.provider "virtualbox" do |v|
  v.customize ["modifyvm", :id, "--memory", opts[:mem], "--cpus", opts[:cpu], "--name", opts[:name]]
end
```
è¿™é‡Œæ˜¯é€šè¿‡virtualå·¥å…·VBoxManagerçš„modifyvmå‘½ä»¤ï¼Œå¯¹VMè¿›è¡Œè®¾ç½®ï¼Œå¯ä»¥è®¾ç½®èµ„æºåˆ†é…ï¼Œè™šæ‹Ÿåç§°ç­‰ç­‰ï¼›

## ç½‘ç»œè®¾ç½®

### host-onlyæ–¹å¼

```ruby
config.vm.network :private_network, ip: "192.168.250.100"
```
ä¸»æœºä¸è™šæ‹Ÿæœºä¹‹é—´çš„ç½‘ç»œäº’è®¿ï¼Œä½†å…¶å®ƒäººè®¿é—®ä¸åˆ°æˆ‘ä»¬åˆ›å»ºçš„è™šæ‹Ÿæœºï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯ä½¿ç”¨çš„host-onlyæ–¹å¼

### bridgeæ¡¥æ¥æ¨¡å¼

```ruby
config.vm.network "public_network", ip: "192.168.250.200"
```

åœ¨æ­¤æ¨¡å¼ä¸‹çš„VMï¼Œç±»ä¼¼ä¸å±€åŸŸç½‘ä¸­çš„ä¸€å°ç‹¬ç«‹çš„è™šæ‹Ÿæœºï¼Œå¯ä»¥è¢«å…¶å®ƒçš„æœºå™¨è®¿é—®ï¼›
åœ¨bridgeæ¡¥æ¥æ¨¡å¼ä¸‹ï¼Œè¿˜å¯ä»¥è®¾ç½®æ¡¥æ¥çš„ç½‘å¡

```ruby
config.vm.network "public_network", :bridge => 'en1: Wi-Fi (AirPort)'
```

### ç«¯å£æ˜ å°„ 
```ruby
config.vm.forwarded_port 80, 8080
æˆ–
config.vm.forwarded_port 80, 8080, protocol: "udp"
```
æŠŠå®¿ä¸»æœºçš„ç«¯å£æ˜ å°„åˆ°è™šæ‹Ÿæœºçš„æŸä¸€ä¸ªç«¯å£ä¸Šé¢ï¼Œè®¿é—®å®¿ä¸»æœºçš„ç«¯å£æ—¶ï¼Œè¯·æ±‚å®é™…æ˜¯è¢«è½¬å‘åˆ°è™šæ‹ŸæœºæŒ‡å®šçš„ç«¯å£ä¸Šé¢ï¼Œé»˜è®¤åªè½¬å‘tcpçš„ç«¯å£ï¼Œå¦‚æœéœ€è¦å…¶å®ƒçš„ç«¯å£ï¼Œéœ€è¦è‡ªè¡Œé…ç½®ï¼Œå¦‚ä¸Šï¼›
## hostnameè®¾ç½®
```ruby
config.vm.hostname = opts[:name]
```
è®¾ç½®ä¸»æœºåï¼Œç”¨äºåŒºåˆ†å¤šå°è™šæ‹Ÿæœºï¼›
## ç›®å½•åŒæ­¥ 
è®¾ç½®ä¸å®¿ä¸»å…±äº«æ–‡ä»¶å¤¹ï¼Œåšå¼€å‘çš„åŒå­¦ï¼Œç»å¸¸ä¼šå†™ä»£ç æ—¶ï¼Œéœ€è¦å‘å¸ƒåˆ°ç¯å¢ƒè¿›è¡Œæµ‹è¯•ï¼Œè¿™æ—¶å¯ä»¥é€šè¿‡è®¾ç½®å…±äº«ç›®å½•çš„æ–¹å¼æ¥å®ç°ï¼›
```ruby
config.vm.synced_folder "/usr/loca/nginx/html/", "/web", create:true,
:owner => "vagrant",
:group => "vagrant",
:mount_options => ["dmode=775","fmode=664â€]
```
- config.vm.synced_folder "å®¿ä¸»æœºæ–‡ä»¶å¤¹è·¯å¾„ï¼ˆå¯ä»¥ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„ï¼‰" "è™šæ‹Ÿæœºæ–‡ä»¶å¤¹è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„ï¼‰" 
- createï¼šboolå€¼ï¼Œå½“hostæœºç›®å½•ä¸å­˜åœ¨æ˜¯ï¼Œæ˜¯å¦è‡ªåŠ¨åˆ›å»ºï¼›
- groupï¼šè™šæ‹Ÿæœºä¸­æ–‡ä»¶å¤¹æ‰€å±çš„ç»„ï¼›
- ownerï¼šè™šæ‹Ÿæœºä¸­æ–‡ä»¶å¤¹æ‰€å±çš„ç”¨æˆ·ï¼›
- mount_options: æƒé™æŒ‚è½½è®¾ç½®ï¼›

## é¢„è®¾æ“ä½œæŒ‡ä»¤
```ruby
config.vm.provision "shell", privileged: true, path: "./setup.sh"
```
é¢„è®¡æ“ä½œæŒ‡ä»¤æœ‰å¾ˆå¤šï¼Œå¯ä»¥å»å®˜ç½‘æŸ¥çœ‹ï¼›

# Vagrantå¸¸ç”¨å‘½ä»¤
| å¸¸ç”¨å‘½ä»¤  |      ä½œç”¨     |
|----------|:-------------:|
|vagrant box add|æ·»åŠ boxåˆ°æœ¬åœ°|
|vagrant box list|æŸ¥çœ‹æœ¬åœ°boxåˆ—è¡¨|
|vagrant box remove|åˆ é™¤box|
|vagrant init|åˆå§‹åŒ–è™šæ‹Ÿæœº|
|vagrant up|å¯åŠ¨è™šæ‹Ÿæœº|
|vagrant halt|å…³é—­è™šæ‹Ÿæœº|
|vagrant status|æŸ¥çœ‹è™šæ‹Ÿæœºè¿è¡ŒçŠ¶æ€|
|vagrant ssh|ç™»å½•è™šæ‹Ÿæœº|
|vagrant destroy|é”€æ¯è™šæ‹Ÿæœº|
|vagrant package|æ‰“åŒ…è™šæ‹ŸæœºæˆBox|

# Vagrantfileç”¨ä¾‹
## åˆ›å»ºä¸€å°dockerè™šæ‹Ÿæœº
```ruby
# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.require_version ">= 1.6.0"

boxes = [
    {
        :name => "docker-vm1",
        :eth1 => "172.16.50.50",
        :mem => "512",
        :cpu => "1"
    }
]

Vagrant.configure(2) do |config|

  config.vm.box = "centos/7"
  boxes.each do |opts|
    config.vm.define opts[:name] do |config|
      config.vm.hostname = opts[:name]
      config.vm.provider "vmware_fusion" do |v|
        v.vmx["memsize"] = opts[:mem]
        v.vmx["numvcpus"] = opts[:cpu]
      end
      config.vm.provider "virtualbox" do |v|
        v.customize ["modifyvm", :id, "--memory", opts[:mem]]
        v.customize ["modifyvm", :id, "--cpus", opts[:cpu]]
      end
      config.vm.network :private_network, ip: opts[:eth1]
    end
  end
  config.vm.synced_folder "./labs", "/home/vagrant/labs"
  config.vm.provision "shell", privileged: true, path: "./setup.sh"
end
```
## åˆ›å»º2å°è™šæ‹Ÿæœºç”¨ä¾‹
```ruby
# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.require_version ">= 1.6.0"

boxes = [
    {
        :name => "docker-vm1",
        :eth1 => "172.16.50.51",
        :mem => "1024",
        :cpu => "1",
        :port => "8778"
    },
    {
        :name => "docker-vm2",
        :eth1 => "172.16.50.52",
        :mem => "1024",
        :cpu => "1"
    }
]

Vagrant.configure(2) do |config|

  config.vm.box = "centos/7"

  boxes.each do |opts|
      config.vm.define opts[:name] do |config|
        config.vm.hostname = opts[:name]
        config.vm.provider "vmware_fusion" do |v|
          v.vmx["memsize"] = opts[:mem]
          v.vmx["numvcpus"] = opts[:cpu]
        end

        config.vm.provider "virtualbox" do |v|
          v.customize ["modifyvm", :id, "--memory", opts[:mem]]
          v.customize ["modifyvm", :id, "--cpus", opts[:cpu]]
        end

        config.vm.network :private_network, ip: opts[:eth1]
      end
  end

  config.vm.synced_folder "./labs", "/home/vagrant/labs"
  config.vm.provision "shell", privileged: true, path: "./setup.sh"

end
```
# vagranté—®é¢˜
```shell
......
The error output from the command was:

mount: unknown filesystem type 'vboxsf'
```
è§£å†³æ–¹å¼ï¼š
vagrant plugin install vagrant-vbguest




